name: Cypress Automation Tests
on:
  workflow_dispatch:

jobs:
  run-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        job_id: [0, 1] # Adjust based on number of containers
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install dependencies
        run: npm ci

      - name: Run Cypress
        run: |
          npx cypress run --spec "$(node cypress-parallel.js ${{ matrix.job_id }} 2)"
      
      - name: Upload HTML Report
        uses: actions/upload-artifact@v4
        with:
          name: report-${{ matrix.job_id }}
          path: cypress/reports/mochawesome.html

  merge-and-publish:
    needs: run-tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Download all HTML report artifacts
        uses: actions/download-artifact@v4
        with:
          path: temp-reports

      - name: Organize reports into folders
        run: |
          mkdir -p gh-pages
          find temp-reports -type f -name '*.html' | while read file; do
            jobname=$(basename $(dirname "$file"))
            mkdir -p "gh-pages/$jobname"
            cp "$file" "gh-pages/$jobname/index.html"
          done

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages
